<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script src="/html/Widgets/JS/canvasjs-2.2/canvasjs.min.js"></script>
        <script src="/html/Widgets/JS/jQuery/jquery-3.3.1.min.js"></script>
        <title>Document</title>
        <script>
            var response = []
            response_1 = []

            Attack = {
                // "link": '/html/XML/TotalAttacks.json',
                "link": 'http://10.39.0.21/blkday/',
                "header": "y"
            }
            Country = {
                // "link": '/html/XML/Countries.json',
                "link": 'http://10.39.0.21/topatck/5',
                "country": "label",
                "count": "y"
            }
            timeDelay = 5 * 1000 //ms
        </script>
        <style>
            body {
                color: white;
                background-color: black;
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            div {
                height: 50vh;
                text-align: center;
                font-size: 5vh;
            }
            h1#count {
                font-size: 10vh;
            }
        </style>
        <script>
            var count = '';
            function compareDataPointYAscend(dataPoint1, dataPoint2) {
                return dataPoint1.y - dataPoint2.y;
            }

            function compareDataPointYDescend(dataPoint1, dataPoint2) {
                return dataPoint2.y - dataPoint1.y;
            }

            function changeNumber(number) {
                // Adds comma decimal places
                var a = document.getElementById('count');
                number = number
                    .toString()
                    .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                a.innerText = number;
            }
            function updateNumber(url, header) {
                // Gets attacks from Felipe's API
                $
                    .getJSON(url)
                    .done(function (json) {
                        console.log("updateNumber Success!");
                        response_1 = json;
                        changeNumber(json[0][header]);
                    })
                    .fail(function (jqxhr, textStatus, error) {
                        var err = textStatus + ", " + error;
                        console.log("Request Failed: " + err);
                        changeNumber(1337)
                    });
            };

            window.setInterval(function () {
                // TODO Update Graph
                updateNumber(Attack["link"], Attack["header"])
            }, timeDelay);
        </script>
    </head>
    <body>
        <div class="body-wrapper">
            <div>Ataques bloqueados apartir de las 0 Hrs.<h1 id="count">0</h1>
            </div>
            <div class="bar-graph" id="paises"></div>
        </div>
        <script>
            window.onload = function () {
                updateNumber(Attack["link"], Attack["header"])
                var chart = new CanvasJS.Chart("paises", {
                    animationEnabled: false,
                    backgroundColor: "black",
                    theme: 'dark2',

                    title: {
                        text: "Países realizando ataques al Tecnológico de Monterrey"
                    },
                    axisX: {
                        interval: 1
                    },
                    axisY: {
                        interval: 20
                    },
                    axisY2: {
                        interlacedColor: "rgba(1,77,101,.2)",
                        gridColor: "rgba(1,77,101,.1)",
                        title: "Número de Ataques"
                    },
                    data: [
                        {
                            type: "bar",
                            name: "Países",
                            axisYType: "secondary",
                            color: "#014D65",
                            dataPoints: []
                        }
                    ]
                });

                // getFromBottle(url["link"], url["country"], url["count"])
                dataPoints = []
                $.getJSON(Country["link"], function (data) {
                    for (var i = 0; i < data.length; i++) {
                        dataPoints.push({label: data[i].label, y: data[i].y});
                    }
                    chart
                        .options
                        .data[0]
                        .dataPoints = dataPoints;
                    chart
                        .options
                        .data[0]
                        .dataPoints
                        .sort(compareDataPointYAscend);

                    chart.render();
                });
                // chart
                //     .options
                //     .data[0]
                //     .dataPoints
                //     .sort(compareDataPointYAscend);
                console.log('Creating chart')
                chart.render();
            }
        </script>
    </body>
</html>